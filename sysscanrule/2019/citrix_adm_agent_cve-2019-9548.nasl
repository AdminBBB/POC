#
# (C) WebRAY, Inc.
#

include("compat.inc");

if (description)
{
  script_id(126053);
  script_version("1.1");
  script_cvs_date("Date: 2019/06/20  6:24:25");

  script_cve_id("CVE-2019-9548");
  script_bugtraq_id(107461);

  script_name(english:"Citrix Application Delivery Management Agent Information Disclosure");
  script_summary(english:"Attempts to obtain ADM agent information.");

  script_set_attribute(attribute:"synopsis", value:
"The remote host is affected by an information disclosure
vulnerability.");
  script_set_attribute(attribute:"description", value:
"The remote Citrix Application Delivery Management (ADM) agent is
affected by an information disclosure vulnerability due to improper
access control in the management interface. An unauthenticated,
remote attacker can exploit this, via a specially crafted HTTP
request, to disclose potentially sensitive information.");
  script_set_attribute(attribute:"see_also", value:
"https://support.citrix.com/article/CTX247738");
  script_set_attribute(attribute:"solution", value:
"Upgrade to Citrix ADM Agent version 12.1 build 50.33 or later,
ADM Agent Cloud version 13.0 build 33.23 or later");
  script_set_cvss_base_vector("CVSS2#AV:N/AC:L/Au:N/C:P/I:P/A:P");
  script_set_cvss3_base_vector("CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H");
  script_set_attribute(attribute:"cvss_score_source", value:"CVE-2019-9548");

  script_set_attribute(attribute:"vuln_publication_date",value:"2019/03/11");
  script_set_attribute(attribute:"patch_publication_date",value:"2019/03/11");
  script_set_attribute(attribute:"plugin_publication_date", value:"2019/06/20");

  script_set_attribute(attribute:"plugin_type",value:"remote");
  script_set_attribute(attribute:"cpe", value:"x-cpe:/a:citrix:application_delivery_management");
  script_set_attribute(attribute:"exploited_by_GizaNE", value:"true");
  script_end_attributes();

  script_category(ACT_ATTACK);
  script_family(english:"CGI abuses");

  script_copyright(english:"This script is Copyright (C) 2019 and is owned by WebRAY, Inc. or an Affiliate thereof.");

  script_dependencies("http_version.nasl");
  script_require_ports("Services/www", 443);

  exit(0);
}

include("audit.inc");
include("global_settings.inc");
include("misc_func.inc");
include("http.inc");

# Prevent fetching /, to which there is no response from
# vulnerable server.
http_disable_keep_alive();

# The web server may be considered broken because / is not accessible.
port = get_http_port(default:443, ignore_broken:TRUE);

# The vuln can only be triggered via https
if(get_port_transport(port) == ENCAPS_IP)
  exit(0, 'Skipped testing non-https port ' + port + '.');

url = '/nitro/v1/config/mps';
res = http_send_recv3(
  item            : url,
  method          : 'GET',
  port            : port,
  exit_on_fail    : TRUE 
);

# "product": "NetScaler MAS Agent"
# "build_number": "12.1: Build 49.37, Date: Oct 16 2018, 11:29:12"
if(  res[2] =~ '"\\s*product\\s*"\\s*:\\s*"\\s*NetScaler MAS Agent\\s*"'
  && res[2] =~ '"\\s*build_number\\s*"\\s*:'
)
{
  security_report_v4(
    port: port,
    severity: SECURITY_HOLE,
    generic:  TRUE,
    request:  make_list(http_last_sent_request()),
    output:   res[2]
  );
}
else
  audit(AUDIT_HOST_NOT, 'affected');
